# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  .github/workflows/ci-cd.yml
#  CI/CD Pipeline â€” Secure CRUD
#
#  Triggers on every push to main:
#    1. Build the Docker image
#    2. Tag as :latest AND :<commit-sha>
#    3. Push both tags to Docker Hub (praty1/secure-crud)
#
#  Required GitHub Secrets:
#    DOCKERHUB_USERNAME â†’ praty1
#    DOCKERHUB_TOKEN    â†’ Docker Hub access token (not your password)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  IMAGE_NAME: praty1/secure-crud

jobs:
  build-and-push:
    name: Build, Tag & Push Docker Image
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ 1. Checkout source code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout Repository
        uses: actions/checkout@v4

      # â”€â”€ 2. Set up Docker Buildx (enables multi-platform) â”€â”€
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # â”€â”€ 3. Log in to Docker Hub â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # â”€â”€ 4. Extract short commit SHA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Get Short Commit SHA
        id: vars
        run: echo "sha_short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      # â”€â”€ 5. Build & Push (latest + commit-sha tags) â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          dockerfile: Dockerfile
          push: ${{ github.event_name == 'push' }}   # Only push on push (not PR)
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.sha_short }}
          cache-from: type=gha
          cache-to:   type=gha,mode=max

      # â”€â”€ 6. Print summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deployment Summary
        if: github.event_name == 'push'
        run: |
          echo "## ðŸš€ Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo ""                              >> $GITHUB_STEP_SUMMARY
          echo "| Tag | Value |"              >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|"              >> $GITHUB_STEP_SUMMARY
          echo "| latest | \`${{ env.IMAGE_NAME }}:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| commit | \`${{ env.IMAGE_NAME }}:${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| short  | \`${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.sha_short }}\` |" >> $GITHUB_STEP_SUMMARY
          echo ""                              >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View on Docker Hub](https://hub.docker.com/r/praty1/secure-crud)" >> $GITHUB_STEP_SUMMARY
